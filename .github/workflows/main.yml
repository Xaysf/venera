name: Build RPM
run-name: Build RPM Package
on:
  workflow_dispatch: {}
  release:
    types: [published]

jobs:
  # 仅保留Linux x64的RPM构建
  Build_Linux_RPM:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version-file: pubspec.yaml
          architecture: x64
      - run: |
          sudo apt-get update -y
          # 安装必要依赖和RPM打包工具
          sudo apt-get install -y ninja-build libgtk-3-dev webkit2gtk-4.1 rpm
      - name: Build Flutter Linux app
        run: flutter build linux --release
      - name: Build RPM package
        run: |
          # 从pubspec提取版本号
          APP_VERSION=$(grep "version:" pubspec.yaml | cut -d':' -f2 | tr -d ' ')
          
          # 创建RPM构建目录结构
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          
          # 复制应用文件到构建目录
          cp -r build/linux/x64/release/bundle/* ~/rpmbuild/BUILD/

          cp -r debian ~/rpmbuild/BUILD/
          sed -i '$a Exec=/usr/local/bin/venera' ~/rpmbuild/BUILD/debian/gui/venera.desktop
          
          # 创建SPEC文件
          cat > ~/rpmbuild/SPECS/venera.spec << EOF
          Name:           venera
          Version:        $APP_VERSION
          Release:        1%{?dist}
          Summary:        Venera application
          License:        GPL-3.0
          URL:            https://github.com/venera-app/venera
          Requires:       gtk3, webkit2gtk4.1
          
          %description
          Venera application built with Flutter
          
          %install
          mkdir -p \$RPM_BUILD_ROOT/usr/local/bin
          mkdir -p \$RPM_BUILD_ROOT/usr/local/lib/venera
          cp -r ~/rpmbuild/BUILD/* \$RPM_BUILD_ROOT/usr/local/lib/venera/
          ln -s /usr/local/lib/venera/venera \$RPM_BUILD_ROOT/usr/local/bin/venera
          
          mkdir -p \$RPM_BUILD_ROOT/usr/share/applications
          cp ~/rpmbuild/BUILD/debian/gui/venera.desktop \$RPM_BUILD_ROOT/usr/share/applications/
          mkdir -p \$RPM_BUILD_ROOT/usr/local/share/icons
          cp ~/rpmbuild/BUILD/debian/gui/venera.png \$RPM_BUILD_ROOT/usr/local/share/icons/


          
          %files
          /usr/local/bin/venera
          /usr/local/lib/venera/*
          /usr/share/applications/venera.desktop
          /usr/local/share/icons/venera.png

          %changelog
          * $(date +"%a %b %d %Y") GitHub Actions <action@github.com> - \$VERSION-1
          - Initial RPM package
          EOF
          
          # 构建RPM包
          rpmbuild -bb ~/rpmbuild/SPECS/venera.spec
          
          # 整理输出文件
          mkdir -p build/linux/rpm
          cp ~/rpmbuild/RPMS/x86_64/*.rpm build/linux/rpm/
      - uses: actions/upload-artifact@v4
        with:
          name: rpm_x64_build
          path: build/linux/rpm/*.rpm

